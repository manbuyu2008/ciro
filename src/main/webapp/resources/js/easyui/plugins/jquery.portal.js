(function(e){function c(x,y){if(y){x.addClass("portal-grid");e("#"+x.attr("id")+"__g > tbody > tr > td").addClass("portal-grid-td")}else{x.removeClass("portal-grid");e("#"+x.attr("id")+"__g > tbody > tr > td").removeClass("portal-grid-td")}}function u(x,A){var z=['<table id="'+x.attr("id")+'__g" style="position:relative;border-collapse: collapse"><tr>'];for(var y=0;y<A;y++){z.push("<td></td>")}z.push("</tr></table>");e(z.join("")).prependTo(x)}function m(B,A){var x=e(B);x.addClass("portal-wrap");if(!x.attr("id")){x.attr("id",e.parser.getObjGUID())}var y=x.attr("id");if(!A){A=e.data(B,"portal")}var z=A.options;A.portal=e('<div class="portal" id="'+y+'__p"></div>').prependTo(x);A.portal.css("margin-left",z.margine.left+"px");A.portal.css("margin-top",z.margine.top+"px");A.portal.css("margin-right",z.margine.right+"px");A.portal.css("margin-bottom",z.margine.bottom+"px");u(A.portal,z.gridColCount);if(!z.readonly){c(A.portal,true)}h(z);x.bind("_resize",{target:B},function(C){r(C.data.target)});r(e("#"+y)[0])}function r(D){var x=e(D);var B=e.data(D,"portal");var A=B.options,C;if(A.fit){C=x.parent();A.width=C.width()-getCssIntValue(C,"padding-left")-getCssIntValue(C,"padding-right");A.height=C.height()-getCssIntValue(C,"padding-bottom")-getCssIntValue(C,"padding-top")}if(!isNaN(A.width)){var y=A.width-getCssIntValue(x,"margin-left")-getCssIntValue(x,"margin-right");if(e.boxModel==true){x.width(y-(x.outerWidth()-x.width()))}else{x.width(y-2)}}else{x.width("auto")}if(!isNaN(A.height)){var z=A.height-getCssIntValue(x,"margin-top")-getCssIntValue(x,"margin-bottom");if(e.boxModel==true){x.height(z-(x.outerHeight()-x.height()))}else{x.height(z-2)}}else{x.height("auto")}g(D,B)}function g(E,y){var B=e(E),F=!y;if(!y){y=e.data(E,"portal")}var D=n(E);if(F&&B.attr("lastscrollheight")==D){return}B.attr("lastscrollheight",D);var x=y.options;var A=B.width();y.portal.height(B.height()-x.margine.top-x.margine.bottom);var G=A-x.margine.left-x.margine.right;y.portal.width(G);var z=y.portal[0];if(D>z.clientHeight){G-=x.scrollbarSize}else{D=z.clientHeight}x.gridColWidth=Math.floor(G/x.gridColCount);e("#"+y.portal.attr("id")+"__g").width(x.gridColCount*x.gridColWidth).height(D).show();var C={gridColWidth:x.gridColWidth,gridRowHeight:x.gridRowHeight,gridColCount:x.gridColCount,margine:x.portletMargine};d(E,function(H){e("#"+H).portlet("portalOptions",C)});x.onResize.call(E,x.width,x.height)}function n(y){var x=0;d(y,function(A){var B=e("#"+A).portlet("options");var z=B.top+B.height;if(x<z){x=z}});return x}function k(D,E){var A=e.data(D,"portal");if(!E.length){E=[E]}var C=0,B,y=[];for(var z=0,x=E.length;z<x;z++){B=E[z];if(B.bounds.left==undefined||!B.bounds.width){B.bounds.left=-999;B.bounds.top=0;B.bounds.width=1;B.bounds.height=15;y.push(B)}else{C=Math.max(C,B.bounds.top+B.bounds.height)}w(D,B,A)}b(D,A,y,C)}function w(A,B,y){if(!y){y=e.data(A,"portal")}var x=y.options;var z=e('<div id="'+B.id+'"></div>').appendTo(y.portal);z.portlet(e.extend({portalId:e(A).attr("id"),readonly:x.readonly,portalOptions:{gridColWidth:x.gridColWidth,gridRowHeight:x.gridRowHeight,gridColCount:x.gridColCount,margine:x.portletMargine},getCellBounds:a,getActualBounds:f,onPortletResize:function(E,D){var C=e(E).attr("portalId");p(e("#"+C)[0],D)},onPortletDrag:function(E,D){var C=e(E).attr("portalId");v(e("#"+C)[0],D)}},B))}function o(y){var x=[];d(y,function(z){var A=e("#"+z).portlet("options");x.push({id:z,key:A.key,bounds:A.bounds})});return x.sort(function(A,z){var B=A.bounds.top-z.bounds.top;if(B!=0){return B}return A.bounds.left-z.bounds.left})}function d(A,z){var x=e(A);var y=[];e("#"+x.attr("id")+"__p > div.portlet").each(function(){var B=e(this).attr("targetid");if(z(B)==false){return false}});return y}function l(x){d(x,function(y){e("#"+y).portlet("close")})}function q(y,x){return(Math.abs(2*y.left+y.width-2*x.left-x.width)<y.width+x.width&&Math.abs(2*y.top+y.height-2*x.top-x.height)<y.height+x.height)}function p(y,z){var x=z.bounds;d(y,function(C){if(z.excludePortletIds.indexOf(C)>=0){return}var D=e("#"+C).portlet("options");var A=D.bounds;var B=z.dir;if(!q(A,x)){return}if(B.indexOf("e")>=0){x.width=A.left-x.left}if(B.indexOf("w")>=0){x.width=x.width+x.left-A.left-A.width;x.left=A.left+A.width}if(!q(A,x)){return}if(B.indexOf("s")>=0){x.height=A.top-x.top}if(B.indexOf("n")>=0){x.height=x.height+x.top-A.top-A.height;x.top=A.top+A.height}})}function v(D,A){var z=e.data(D,"portal");var B={gridColWidth:z.options.gridColWidth,gridRowHeight:z.options.gridRowHeight,gridColCount:z.options.gridColCount,margine:z.options.portletMargine};var x=f(A.bounds,B);var y=e.extend({},x);var E=f(A.lastBounds,B);var H=B.gridColWidth*B.gridColCount;var C={left:0,top:0,right:H,bottom:99999};var G=A.pageX,F=A.pageY+z.portal.scrollTop();d(D,function(J){if(A.excludePortletIds.indexOf(J)>=0){return}var K=e("#"+J).portlet("options");var I=f(K.bounds,B);if(G>=I.left&&G<=I.left+I.width&&F>=I.top&&F<=I.top+I.height){A.accept=false;return false}if(G<I.left){C.right=Math.min(C.right,I.left)}else{if(G>I.left+I.width){C.left=Math.max(C.left,I.left+I.width)}}if(F<I.top){C.bottom=Math.min(C.bottom,I.top)}else{if(F>I.top+I.height){C.top=Math.max(C.top,I.top+I.height)}}if(!q(I,x)){return}if(G<I.left){x.width=I.left-x.left}if(!q(I,x)){return}if(F<I.top){x.height=I.top-x.top}if(!q(I,x)){return}if(G>I.left){x.left=I.left+I.width}if(!q(I,x)){return}if(F>I.top){x.top=I.top+I.height}});if(!A.accept){return}if(x.left+x.width>H){x.width=H-x.left}if(x.width<y.width||x.height<y.height){x.width=Math.min(y.width,C.right-C.left);x.left=C.right-x.width;C.bottom=Math.min(C.bottom,Math.max(x.top+x.height,y.top+y.height,E.top+E.height));x.height=Math.min(y.height,C.bottom-C.top);x.top=C.bottom-x.height}x=a(x,B);A.bounds.left=x.left;A.bounds.top=x.top;A.bounds.width=x.width;A.bounds.height=x.height}function a(y,x){return{left:Math.floor(y.left/x.gridColWidth),top:Math.floor(y.top/x.gridRowHeight),width:Math.floor(y.width/x.gridColWidth),height:Math.floor(y.height/x.gridRowHeight)}}function f(y,x){return{left:y.left*x.gridColWidth,top:y.top*x.gridRowHeight,width:y.width*x.gridColWidth,height:y.height*x.gridRowHeight}}function t(z,x){var y=e.data(z,"portal");y.options.readonly=x;c(y.portal,!x);d(z,function(A){e("#"+A).portlet("setReadOnly",x)})}function h(y){var x=[];for(i=0,len=y.columnWidths.length;i<len;i++){x.push(Math.round(y.columnWidths[i]*y.gridColCount/100))}y.colCellWidths=x}function s(A,B){var z=e.data(A,"portal");var y=z.options;y.columnWidths=B;h(y);var x=o(A);b(A,z,x,0)}function b(H,y,F,I){var x=y.options;var J=x.colCellWidths;if(!I){I=0}var B=0,C=0,A=J[0];var D={gridColWidth:x.gridColWidth,gridRowHeight:x.gridRowHeight,gridColCount:x.gridColCount,margine:x.portletMargine};var E,G;for(E=0,G=F.length;E<G;E++){var z=F[E];e("#"+z.id).portlet("portletResize",{bounds:{left:C,top:I,width:A,height:15},portalOptions:D});B++;if(B<x.columnWidths.length){C+=A;A=J[B]}else{I+=15;C=0;A=J[0];B=0}}}function j(x){e("#"+e(x).attr("id")+"__p").css("overflow-y","hidden");d(x,function(y){e("#"+y).portlet("maximize")})}e.fn.portal=function(x,y){if(typeof x=="string"){return e.fn.portal.methods[x](this,y)}x=x||{};return this.each(function(){var z=e.data(this,"portal");if(z){e.extend(z.options,x)}else{z=e.data(this,"portal",{options:e.extend({},e.fn.portal.defaults,x)});m(this,z)}if(z.options.border){e(this).removeClass("portal-noborder")}else{e(this).addClass("portal-noborder")}r(this)})};e.fn.portal.methods={options:function(x){return e.data(x[0],"portal").options},resize:function(y,x){return y.each(function(){if(x){var z=e.data(this,"portal").options;if(x.width){z.width=x.width}if(x.height){z.height=x.height}}r(this)})},getPortlets:function(x){return o(x[0])},add:function(y,x){return k(y[0],x)},clear:function(x){return l(x[0])},remove:function(y,x){return e("#"+x).portlet("close")},setReadOnly:function(y,x){t(y[0],x)},layout:function(y,x){s(y[0],x)},maximizePortlet:function(x){j(x[0])}};e.fn.portal.defaults={width:"auto",height:"auto",border:true,fit:true,columnWidths:[50,50],readonly:true,gridColCount:16,gridRowHeight:20,scrollbarSize:18,margine:{left:0,top:0,right:0,bottom:0},portletMargine:{left:10,top:10,right:0,bottom:0},autoArrange:{afterDrag:true,afterResize:false,left:true,top:true,leftPrior:true},onResize:function(y,x){},onStateChange:function(){}}})(jQuery);